<!DOCTYPE html> <!--[if gt IE 8]><!-->
<html class="no-js">
  <!--<![endif]-->
  <head>
    <title>LLMs for Personalizing Traffic School Learning - Engineering @ Strativ AB</title>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.2.2/dist/css/bootstrap.min.css"
      rel="stylesheet"
      integrity="sha384-Zenh87qX5JnK2Jl0vWa8Ck2rdkQ2Bzep5IDxbcnCeuOxjzrPF/et3URy9Bv1WTRi"
      crossorigin="anonymous"
    />
    <link href="https://strativ-dev.github.io/engineering-at-strativ/theme/style.css" rel="stylesheet" />

    <script
      src="https://use.fontawesome.com/releases/v5.15.3/js/all.js"
      crossorigin="anonymous"
    ></script>
    <link
      rel="stylesheet"
      href="https://cdn.jsdelivr.net/gh/jpswalsh/academicons@1/css/academicons.min.css"
    />

    <meta name="viewport" content="width=device-width, initial-scale=1" />
          </head>

  <body id="index">
    <nav
      class="navbar navbar-expand-lg mb-4 custom-dark-background"
      role="navigation"
    >
      <div class="container">
        <a class="navbar-brand text-ivory" href="https://strativ-dev.github.io/engineering-at-strativ" style="color: #F7F7E8">
          <svg
            xmlns="http://www.w3.org/2000/svg"
            width="32"
            height="32"
            viewBox="0 0 60 36"
          >
            <path
              d="M25.997 35.982h-2.913c-1.012 0-1.232-.182-1.451-1.191l-1.799-8.346c-1.353-6.266-2.71-12.531-4.068-18.797-.089-.422-.178-.882-.747-.844-.507.02-.6.422-.688.844a53609.076 53609.076 0 0 1-5.952 27.43 1.018 1.018 0 0 1-1.152.912c-2.026-.03-4.052 0-6.082 0-1.114 0-1.304-.245-1.038-1.334.819-3.402 1.64-6.804 2.465-10.205C4.1 18.098 5.625 11.743 7.147 5.384 7.94 2.098 9.899.438 13.25.104a15.07 15.07 0 0 1 5.095.267c2.532.62 3.997 2.331 4.592 4.802 2.38 9.839 4.748 19.68 7.103 29.52.24 1.002 0 1.293-1.063 1.297l-2.98-.008ZM42.441 35.969c-.464-.11-.932-.216-1.397-.338-2.532-.684-3.946-2.433-4.545-4.933-2.277-9.49-4.556-18.982-6.838-28.478-.089-.367-.186-.735-.262-1.106-.152-.748.093-1.086.845-1.103 1.012-.025 2.03 0 3.043 0h3.102c.958 0 1.22.211 1.426 1.162l2.305 10.699c1.19 5.505 2.383 11.007 3.58 16.507.06.287.207.55.421.751.389.338.844.051.996-.625.393-1.727.764-3.459 1.136-5.19 1.61-7.42 3.217-14.842 4.824-22.265.186-.844.422-1.043 1.3-1.043h5.91c1.168 0 1.37.245 1.105 1.356-1.275 5.308-2.554 10.617-3.837 15.928-1.072 4.469-2.147 8.938-3.224 13.407-.743 3.074-2.461 4.646-5.589 5.148-.12.03-.238.072-.35.127l-3.95-.004Z"
              fill="#FF5A00"
            ></path>
          </svg>
          <span class="ms-2">Engineering @ Strativ AB</span></a
        >
        <button
          class="navbar-toggler"
          type="button"
          data-bs-toggle="collapse"
          data-bs-target=".navbar-collapse"
          aria-controls="navbarNav"
          aria-expanded="false"
          aria-label="Toggle navigation"
        >
          <span class="navbar-toggler-icon"></span>
        </button>
        <div class="collapse navbar-collapse">
          <ul class="navbar-nav">
            <li>
              <a
                class="text-white me-2 ms-2"
                href="https://strativ-dev.github.io/engineering-at-strativ/categories.html"
                >categories</a
              >
            </li>
             <li>
              <a class="text-white me-2 ms-2" href="https://strativ-dev.github.io/engineering-at-strativ/tags.html"
                >tags</a
              >
            </li>
            <li>
              <a class="text-white me-2 ms-2" href="https://strativ-dev.github.io/engineering-at-strativ/archives.html"
                >archives</a
              >
            </li>
          </ul>
        </div>
      </div>
    </nav>

    <div class="container">

    <section id="content" class="article content">
      <header>
        <h2 class="entry-title">
          LLMs for Personalizing Traffic School Learning
        </h2>
        
        <div class="text-orange">Fri 22 September 2023</div>
      </header>

      <p>Written by: Saqibur Rahman</p>

<!-- .entry-content -->
      <div class="entry-content">
        <!-- Series: Safe Trafikskola Case Study -->

<h1>Using generative AI to automate a part of Safe Trafikskola's digitized driving license journey</h1>
<h2>Problem Statement</h2>
<p>Among the many things that we've worked on with Safe Trafikskola as part of their goal to digitize a student's driving license journey, a few key aspects have a lot to be desired.</p>
<ul>
<li>Content: Right now, from the app, you can read quite a bit of theory content that's relevant to your 'theory' exam - sure you can "read" but if a student has trouble with any of the material, the next bet is to chat directly with your asssigned mentor. This doesn't really "scale" from a human resource perspective, and there's no limit to the different questions a student can ask.</li>
<li>Quizzes and Exams: To strengthen your theory knowledge, we have quizzes and exams in the app which follow the MCQ format - while the questions are randomized each time you attempt a quiz, you don't really get any feedback for wrong answers. Further, even if you're weak at a topic, you can't really "practice" it per-se, as you can easily just memorize the answers, or not be relevant to the material you're particularly struggling with.</li>
<li>Simulator: We have missions in our simulator that students can try right from their homes to "practise" driving without actually booking a practical lesson at the school - ideally, we'd be able to suggest students the missions they need to try out based on a few things: 1. what theory material they're struggling with and 2. what they're struggling with in practical lessons and 3. what they're struggling with in the simulator itself.</li>
</ul>
<p>Each of these problems have some form of technical solution that we can probably map-out with quite a bit of programming logic. But, what if it's cost efficient to abstract this to an LLM layer that <em>really</em> adapts to a student's education.</p>
<p>So, to summarize, combine the different aspects a student experience in their digitized driving license joureny at Safe Trafikskola, and offer a tailored "AI-mentor" who's able to reduce the amount of effort and cost needed for someone to actually get their license. We've built a rich eco-system afterall, so it'll be great to be able to use it.</p>
<h2>Technicalities</h2>
<p>Let's start off with a baseline, everything presented today is experimental and proof-of-concept. Since we're dealing with "generative" AI, it'll be hard to gauge a deterministic output/outcome for each step we automate. Regardless, let's shoot for the stars, and maybe we'll land on the moon.</p>
<h3>Content</h3>
<p>The theory material we have at Safe Trafikskola right now, is mostly pretty-much static - that is to say, it's been an year and we're just starting to make some new changes. For our demonstration today - let's take a stab at creating a "query-able" knowledge base.</p>
<h4>Knowledge Base</h4>
<p>We have a dump of all the theory content that's accessible to students, organized into chapters. Without going into the nitty-gritty details of <a href="https://terminusdb.com/blog/vector-database-and-vector-embeddings/">how to build a knowledge base</a>, let's summarize as:
* Fetch text data from a source (dump or from a <code>contents</code> API
* Create text vector embeddings from text data using any embedding model, we'll use <a href="https://platform.openai.com/docs/guides/embeddings/embeddings">OpenAI's embedding model</a> in this demo
* Store the vectors in a <a href="https://www.pinecone.io/learn/vector-database/">vector database</a>, we'll use <a href="https://www.trychroma.com/">ChromaDB</a> for this demo because it's super easy to run and test in a Jupyter Notebook environment</p>
<p>Side-note regarding dynamic content: It's rare that traffic rules, regulations and the theory content designed around will change. Either way, content <em>can</em> change. But "what if?" - in which case, storing that content as an embedding in the vector database, when it does change is enough to get the ball rolling.</p>
<h5>Building the knowledge base</h5>
<ul>
<li>To keep things simple and also demo how to build your "knowledge base" from any HTML file, I'm going to Safe Trafikskola's content APIs.</li>
<li>The LangChain module we're going to use is a <a href="https://python.langchain.com/docs/modules/data_connection/document_loaders/">document loader</a> - more specifically, a <code>AsyncHtmlLoader</code> which will let us hit a bunch of web pages and fetch their HTML data.</li>
</ul>
<h5>Chapters</h5>
<p>We're going to fetch 5 chapters. In order, they discuss:</p>
<ol>
<li>About "traffic" - introduces the student about the pedestrians, cars, and everything on the road that coutns as traffic.</li>
<li>About "the road" - what classifies as a "road" and what the lanes are</li>
<li>Almost everything about a "B-driving license"</li>
<li>About stopping distance and safely stopping the car</li>
<li>About the priority of right rule and exiting a junction</li>
</ol>
<div class="codehilite"><pre><span></span><code><span class="kn">from</span> <span class="nn">langchain.document_loaders</span> <span class="kn">import</span> <span class="n">AsyncHtmlLoader</span>

<span class="c1"># URLs for the first &#39;content&#39; chapters that we have in the system.</span>
<span class="n">urls</span> <span class="o">=</span> <span class="p">[</span>
    <span class="c1"># Replace with actualy URLs</span>
    <span class="s2">&quot;***&quot;</span><span class="p">,</span>
    <span class="s2">&quot;***&quot;</span><span class="p">,</span>
    <span class="s2">&quot;***&quot;</span><span class="p">,</span>
    <span class="s2">&quot;***&quot;</span><span class="p">,</span>
    <span class="s2">&quot;***&quot;</span><span class="p">,</span>
<span class="p">]</span>
<span class="n">html_loader</span> <span class="o">=</span> <span class="n">AsyncHtmlLoader</span><span class="p">(</span><span class="n">urls</span><span class="p">)</span>
<span class="n">content_chapters</span> <span class="o">=</span> <span class="n">html_loader</span><span class="o">.</span><span class="n">load</span><span class="p">()</span>

<span class="sa">f</span><span class="s2">&quot;Number of chapters fetched </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">content_chapters</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span>

<span class="n">Fetching</span> <span class="n">pages</span><span class="p">:</span> <span class="mi">100</span><span class="o">%|</span><span class="c1">#############################################################################| 5/5 [00:02&lt;00:00,  1.93it/s]</span>

<span class="s1">&#39;Number of chapters fetched 5&#39;</span>
</code></pre></div>

<p>From there, we're going to clean up the HTML a bit, that is, convert it from "raw" HTML with all the tags, and instead into some markdown, something the LLM will understand quite nicely.</p>
<p>Additionally, we're also going to "split" each chapter based on headers, so that topics are clearly separated between each other. This also plays nicely into how many <a href="https://platform.openai.com/docs/introduction/tokens">tokens</a> you can pass to the model as context.</p>
<div class="codehilite"><pre><span></span><code><span class="kn">from</span> <span class="nn">langchain.document_transformers</span> <span class="kn">import</span> <span class="n">Html2TextTransformer</span>
<span class="kn">from</span> <span class="nn">langchain.text_splitter</span> <span class="kn">import</span> <span class="n">MarkdownTextSplitter</span>

<span class="c1"># This nicely converts our HTML to markdown</span>
<span class="n">html2text</span> <span class="o">=</span> <span class="n">Html2TextTransformer</span><span class="p">()</span>
<span class="n">markdown_documents</span> <span class="o">=</span> <span class="n">html2text</span><span class="o">.</span><span class="n">transform_documents</span><span class="p">(</span><span class="n">content_chapters</span><span class="p">)</span>

<span class="n">text_splitter</span> <span class="o">=</span> <span class="n">MarkdownTextSplitter</span><span class="p">()</span>
<span class="n">content</span> <span class="o">=</span> <span class="n">text_splitter</span><span class="o">.</span><span class="n">split_documents</span><span class="p">(</span><span class="n">markdown_documents</span><span class="p">)</span>
</code></pre></div>

<p>A small part of what we ended up with:</p>
<div class="codehilite"><pre><span></span><code><span class="n">content</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">page_content</span><span class="p">[</span><span class="mi">1405</span><span class="p">:</span><span class="mi">1950</span><span class="p">]</span> <span class="o">+</span> <span class="s2">&quot;...&quot;</span>

<span class="s1">&#39;En del fordon med elmotor räknas</span><span class="se">\n</span><span class="s1">som cyklar medan andra inte gör det och då många populära fordon i samhället</span><span class="se">\n</span><span class="s1">är eldrivna idag så gäller det att vara uppmärksam på vad det är slags fordon</span><span class="se">\n</span><span class="s1">som du framför och om detta är något som du måste ha ett körkort för eller</span><span class="se">\n</span><span class="s1">inte. Det finns även många lagar som definierar var somliga fordon får och</span><span class="se">\n</span><span class="s1">inte får framföras samt vilken typ av skyddsutrustning som krävs för att</span><span class="se">\n</span><span class="s1">framföra dem och beroende på ditt fordonsval så är detta något du måste känna</span><span class="se">\n</span><span class="s1">till och har en skyldighet att ta reda på. Motordrivna f...&#39;</span>
</code></pre></div>

<p>Now, there's quite a lot we can do when "building" our knowledge base. There are also quite a few caveats and things to consider. Nevertheless, this is a demonstration. So let's move on ahead as this is a good starting point.</p>
<p>Next, we'll create vector embeddings from our text data</p>
<div class="codehilite"><pre><span></span><code><span class="kn">from</span> <span class="nn">langchain.embeddings</span> <span class="kn">import</span> <span class="n">OpenAIEmbeddings</span>
<span class="kn">from</span> <span class="nn">langchain.vectorstores</span> <span class="kn">import</span> <span class="n">Chroma</span>

<span class="c1"># This creates embeddings from the text data and stores it in our vector database.</span>
<span class="n">db</span> <span class="o">=</span> <span class="n">Chroma</span><span class="o">.</span><span class="n">from_documents</span><span class="p">(</span><span class="n">content</span><span class="p">,</span> <span class="n">OpenAIEmbeddings</span><span class="p">())</span>
</code></pre></div>

<p>So, as an example, let's "ask" our knowledge base about "Trafikanter" a.k.a "Traffic"</p>
<div class="codehilite"><pre><span></span><code><span class="c1"># The query is also converted to a vector and then searched against our knowledge-base -</span>
<span class="c1"># https://python.langchain.com/docs/integrations/vectorstores/chroma</span>

<span class="c1"># English: &#39;What&#39;s a part of traffic?&#39;</span>
<span class="n">answer_context</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">similarity_search</span><span class="p">(</span><span class="s2">&quot;Vad är en del av trafiken?&quot;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span> <span class="c1"># We&#39;re only going consider the &quot;best&quot; match</span>
<span class="n">answer_context</span><span class="o">.</span><span class="n">page_content</span><span class="p">[:</span><span class="mi">100</span><span class="p">]</span> <span class="o">+</span> <span class="s2">&quot;...&quot;</span>
</code></pre></div>

<div class="codehilite"><pre><span></span><code><span class="s1">&#39;# Trafikanter I trafiken är alla “Trafikanter.” Detta gäller vare sig du</span><span class="se">\n</span><span class="s1">promenerar, kör bil eller r...&#39;</span><span class="w"></span>
</code></pre></div>

<p>We've correctly retrived the correct context. Now we can "prompt" the model to "generate" an answer based from our "knowledge base".</p>
<h4>Pretending to be a mentor</h4>
<div class="codehilite"><pre><span></span><code><span class="kn">from</span> <span class="nn">langchain.prompts.chat</span> <span class="kn">import</span> <span class="p">(</span>
    <span class="n">ChatPromptTemplate</span><span class="p">,</span>
    <span class="n">SystemMessagePromptTemplate</span><span class="p">,</span>
    <span class="n">HumanMessagePromptTemplate</span><span class="p">,</span>
<span class="p">)</span>

<span class="c1"># Not the best prompt ever, but again, something that gets the job done.</span>
<span class="n">template</span> <span class="o">=</span> <span class="p">(</span>
    <span class="s2">&quot;In this scenario, you&#39;re a mentor at the traffic school &#39;Safe Trafikskola,&#39; &quot;</span>
    <span class="s2">&quot;which specializes in teaching students about driving and traffic. You&#39;re currently &quot;</span>
    <span class="s2">&quot;helping a student prepare for their upcoming driving test. The student is curious &quot;</span>
    <span class="s2">&quot;about </span><span class="si">{context}</span><span class="s2">. Craft a response based on this context, ensuring that your reply includes a leading question &quot;</span>
    <span class="s2">&quot;related to the chosen topic. If the user responds to your question, evaluate the accuracy &quot;</span>
    <span class="s2">&quot;of their answer based on the context, tell them whether they&#39;re right or wrong and provide a short &quot;</span>
    <span class="s2">&quot;feedback within one or two sentences in the same language as the user. If the user does not answer &quot;</span>
    <span class="s2">&quot;your question, ask them to answer it.&quot;</span>
<span class="p">)</span>

<span class="n">system_message_prompt</span> <span class="o">=</span> <span class="n">SystemMessagePromptTemplate</span><span class="o">.</span><span class="n">from_template</span><span class="p">(</span><span class="n">template</span><span class="p">)</span>
<span class="n">human_template</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="si">{text}</span><span class="s2">&quot;</span>
<span class="n">human_message_prompt</span> <span class="o">=</span> <span class="n">HumanMessagePromptTemplate</span><span class="o">.</span><span class="n">from_template</span><span class="p">(</span><span class="n">human_template</span><span class="p">)</span>
<span class="n">chat_prompt</span> <span class="o">=</span> <span class="n">ChatPromptTemplate</span><span class="o">.</span><span class="n">from_messages</span><span class="p">([</span><span class="n">system_message_prompt</span><span class="p">,</span> <span class="n">human_message_prompt</span><span class="p">])</span>
</code></pre></div>

<div class="codehilite"><pre><span></span><code><span class="kn">from</span> <span class="nn">langchain.schema</span> <span class="kn">import</span> <span class="n">StrOutputParser</span>
<span class="kn">from</span> <span class="nn">langchain.chains</span> <span class="kn">import</span> <span class="n">LLMChain</span>
<span class="kn">from</span> <span class="nn">langchain.chat_models</span> <span class="kn">import</span> <span class="n">ChatOpenAI</span>

<span class="n">chain</span> <span class="o">=</span> <span class="n">LLMChain</span><span class="p">(</span>
    <span class="n">llm</span><span class="o">=</span><span class="n">ChatOpenAI</span><span class="p">(),</span>
    <span class="n">prompt</span><span class="o">=</span><span class="n">chat_prompt</span><span class="p">,</span>
    <span class="n">output_parser</span><span class="o">=</span><span class="n">StrOutputParser</span><span class="p">()</span>
<span class="p">)</span>

<span class="n">model_answer</span> <span class="o">=</span> <span class="n">chain</span><span class="o">.</span><span class="n">run</span><span class="p">({</span> <span class="s2">&quot;context&quot;</span><span class="p">:</span> <span class="n">answer_context</span><span class="p">,</span> <span class="s2">&quot;text&quot;</span><span class="p">:</span> <span class="s2">&quot;Vad är stoppsträcka?&quot;</span> <span class="p">})</span>
<span class="n">model_answer</span>
</code></pre></div>

<div class="codehilite"><pre><span></span><code>&#39;Stoppsträcka är den sträcka som ett fordon behöver för att stanna helt efter att föraren har tryckt på bromsen. Det inkluderar både reaktionstiden för föraren att reagera och bromssträckan som fordonet behöver för att stanna. Vad tror du är viktigt att tänka på när det gäller stoppsträcka?&#39;
</code></pre></div>

<p>Translation: "Stopping distance is the distance a vehicle needs to come to a complete stop after the driver has applied the brake. It includes both the reaction time for the driver to react and the braking distance the vehicle needs to stop. What do you think is important to consider when it comes to stopping distance?"</p>
<p>Not bad. If we want, we can pass this as part of the next context, so that the model can try validating whether the student answers this question correctly. But that's a separate problem altogether. Either way, here's a shot.</p>
<div class="codehilite"><pre><span></span><code><span class="kn">from</span> <span class="nn">langchain.prompts.chat</span> <span class="kn">import</span> <span class="n">SystemMessage</span>

<span class="n">chain</span><span class="o">.</span><span class="n">prompt</span> <span class="o">=</span> <span class="n">ChatPromptTemplate</span><span class="o">.</span><span class="n">from_messages</span><span class="p">([</span><span class="n">system_message_prompt</span><span class="p">,</span> <span class="n">human_message_prompt</span><span class="p">,</span> <span class="n">SystemMessage</span><span class="p">(</span><span class="n">content</span><span class="o">=</span><span class="n">model_answer</span><span class="p">)])</span>
<span class="n">chain</span><span class="o">.</span><span class="n">run</span><span class="p">({</span> <span class="s2">&quot;context&quot;</span><span class="p">:</span> <span class="n">answer_context</span><span class="p">,</span> <span class="s2">&quot;text&quot;</span><span class="p">:</span> <span class="s2">&quot;Reaktionssträckan – beräkning&quot;</span> <span class="p">})</span>
</code></pre></div>

<div class="codehilite"><pre><span></span><code>&#39;Viktiga faktorer att tänka på när det gäller stoppsträcka är hastigheten, väglaget och bromssystemets skick. Hastigheten påverkar både reaktionstiden och bromssträckan. Vid högre hastigheter ökar både reaktionstiden och bromssträckan, vilket leder till en längre stoppsträcka. Väglaget, såsom våt eller isig vägbana, kan också påverka bromssträckan. Slutligen är det viktigt att ha ett fungerande bromssystem för att kunna stanna på kortast möjliga sträcka.&#39;
</code></pre></div>

<p>Not the best answer, but not the worst either. There are couple of ways to "fix" this:
* Fine-tuning the model to act the way we want it to by feeding a bunch of QnA examples where it leads to students to an answer - https://platform.openai.com/docs/guides/fine-tuning
* Better prompts</p>
<h3>Quizzes and Exams</h3>
<p>Moving on to the next phase, quizzes. Let's try to:
* Generate new questions based on the "context" that we can show in the app</p>
<div class="codehilite"><pre><span></span><code><span class="c1"># We&#39;re going to set-up it, so that the JSON format is something the mobile-app already expects.</span>
<span class="c1"># This also (in most cases) ensures that the app doesn&#39;t break with a malformed response</span>

<span class="kn">from</span> <span class="nn">typing</span> <span class="kn">import</span> <span class="n">List</span><span class="p">,</span> <span class="n">Optional</span>

<span class="kn">from</span> <span class="nn">langchain.output_parsers</span> <span class="kn">import</span> <span class="n">PydanticOutputParser</span>
<span class="kn">from</span> <span class="nn">langchain.pydantic_v1</span> <span class="kn">import</span> <span class="n">BaseModel</span><span class="p">,</span> <span class="n">Field</span><span class="p">,</span> <span class="n">validator</span>


<span class="k">class</span> <span class="nc">Answer</span><span class="p">(</span><span class="n">BaseModel</span><span class="p">):</span>
    <span class="n">text</span><span class="p">:</span> <span class="nb">str</span>
    <span class="n">is_correct</span><span class="p">:</span> <span class="nb">bool</span>

<span class="k">class</span> <span class="nc">Question</span><span class="p">(</span><span class="n">BaseModel</span><span class="p">):</span>
    <span class="n">uuid</span><span class="p">:</span> <span class="nb">str</span>
    <span class="n">text</span><span class="p">:</span> <span class="nb">str</span>
    <span class="n">answers</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Answer</span><span class="p">]</span>

<span class="k">class</span> <span class="nc">Quiz</span><span class="p">(</span><span class="n">BaseModel</span><span class="p">):</span>
    <span class="n">questions</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Question</span><span class="p">]</span>
</code></pre></div>

<div class="codehilite"><pre><span></span><code><span class="kn">from</span> <span class="nn">langchain.prompts</span> <span class="kn">import</span> <span class="n">PromptTemplate</span>
<span class="kn">from</span> <span class="nn">langchain.llms</span> <span class="kn">import</span> <span class="n">OpenAI</span>

<span class="n">question</span> <span class="o">=</span> <span class="s2">&quot;Jag vill träna på B-körkort.&quot;</span>
<span class="n">answer_context</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">similarity_search</span><span class="p">(</span><span class="n">question</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span> <span class="c1"># We&#39;re only going consider the &quot;best&quot; match</span>
<span class="n">answer_context</span><span class="o">.</span><span class="n">page_content</span><span class="p">[:</span><span class="mi">100</span><span class="p">]</span> <span class="o">+</span> <span class="s2">&quot;...&quot;</span>

<span class="n">parser</span> <span class="o">=</span> <span class="n">PydanticOutputParser</span><span class="p">(</span><span class="n">pydantic_object</span><span class="o">=</span><span class="n">Quiz</span><span class="p">)</span>
<span class="n">format_instructions</span> <span class="o">=</span> <span class="n">parser</span><span class="o">.</span><span class="n">get_format_instructions</span><span class="p">()</span>

<span class="n">quiz_template</span> <span class="o">=</span> <span class="p">(</span>
    <span class="s2">&quot;Based on the context = </span><span class="si">{context}</span><span class="s2">, create 5 different multiple choice questions with a single right answer using a question as the title &quot;</span>
    <span class="s2">&quot;, in </span><span class="si">{format_instructions}</span><span class="s2"> &quot;</span>
    <span class="s2">&quot;in the same language as the context.&quot;</span>
<span class="p">)</span>


<span class="n">prompt</span> <span class="o">=</span> <span class="n">PromptTemplate</span><span class="p">(</span>
    <span class="n">template</span><span class="o">=</span><span class="n">quiz_template</span><span class="p">,</span>
    <span class="n">input_variables</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;context&quot;</span><span class="p">],</span>
    <span class="n">partial_variables</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;format_instructions&quot;</span><span class="p">:</span> <span class="n">parser</span><span class="o">.</span><span class="n">get_format_instructions</span><span class="p">()},</span>
<span class="p">)</span>

<span class="n">_input</span> <span class="o">=</span> <span class="n">prompt</span><span class="o">.</span><span class="n">format_prompt</span><span class="p">(</span><span class="n">context</span><span class="o">=</span><span class="n">answer_context</span><span class="p">)</span>

<span class="n">model_name</span> <span class="o">=</span> <span class="s2">&quot;gpt-3.5-turbo&quot;</span>
<span class="n">temperature</span> <span class="o">=</span> <span class="mf">0.0</span>
<span class="n">model</span> <span class="o">=</span> <span class="n">OpenAI</span><span class="p">(</span><span class="n">model_name</span><span class="o">=</span><span class="n">model_name</span><span class="p">,</span> <span class="n">temperature</span><span class="o">=</span><span class="n">temperature</span><span class="p">)</span>
<span class="n">output</span> <span class="o">=</span> <span class="n">model</span><span class="p">(</span><span class="n">_input</span><span class="o">.</span><span class="n">to_string</span><span class="p">())</span>

<span class="n">quiz</span> <span class="o">=</span> <span class="n">parser</span><span class="o">.</span><span class="n">parse</span><span class="p">(</span><span class="n">output</span><span class="p">)</span>
</code></pre></div>

<div class="codehilite"><pre><span></span><code>Quiz(questions=[Question(uuid=&#39;1&#39;, text=&#39;Vad innebär ett B-körkort?&#39;, answers=[Answer(text=&#39;Rättigheter att köra en massa saker&#39;, is_correct=True), Answer(text=&#39;Endast rättigheter att köra en vanlig bil&#39;, is_correct=False), Answer(text=&#39;Rättigheter att köra buss med över åtta sittplatser&#39;, is_correct=False), Answer(text=&#39;Endast rättigheter att köra terränghjuling&#39;, is_correct=False)]), Question(uuid=&#39;2&#39;, text=&#39;Vilken typ av fordon får man inte köra med ett B-körkort?&#39;, answers=[Answer(text=&#39;Personbil med högst 8 sittplatser&#39;, is_correct=False), Answer(text=&#39;Buss med över åtta sittplatser&#39;, is_correct=True), Answer(text=&#39;Lätt släpfordon med totalvikt över 750kg&#39;, is_correct=False), Answer(text=&#39;Motorredskap klass 1&#39;, is_correct=False)]), Question(uuid=&#39;3&#39;, text=&#39;Vad krävs för att få köra terränghjuling?&#39;, answers=[Answer(text=&#39;Ett förarbevis för terränghjuling&#39;, is_correct=True), Answer(text=&#39;Ett B-körkort&#39;, is_correct=False), Answer(text=&#39;Ett förarbevis för motorredskap klass 1&#39;, is_correct=False), Answer(text=&#39;Ett förarbevis för terrängvagn&#39;, is_correct=False)]), Question(uuid=&#39;4&#39;, text=&#39;Vilken typ av fordon får man köra med ett B-körkort?&#39;, answers=[Answer(text=&#39;Moped klass 2&#39;, is_correct=True), Answer(text=&#39;Terrängvagn&#39;, is_correct=False), Answer(text=&#39;Fyrhjulig motorcykel&#39;, is_correct=False), Answer(text=&#39;Lastbilssläp&#39;, is_correct=False)]), Question(uuid=&#39;5&#39;, text=&#39;Vad ingår i behörigheten för ett B-körkort?&#39;, answers=[Answer(text=&#39;Moped klass 1&#39;, is_correct=True), Answer(text=&#39;Motorredskap klass 2&#39;, is_correct=True), Answer(text=&#39;A och B traktorer&#39;, is_correct=True), Answer(text=&#39;Terränghjuling&#39;, is_correct=False)])])


{&#39;questions&#39;: [{&#39;uuid&#39;: &#39;1&#39;,
   &#39;text&#39;: &#39;Vad innebär ett B-körkort?&#39;,
   &#39;answers&#39;: [{&#39;text&#39;: &#39;Rättigheter att köra en massa saker&#39;,
     &#39;is_correct&#39;: True},
    {&#39;text&#39;: &#39;Endast rättigheter att köra en vanlig bil&#39;, &#39;is_correct&#39;: False},
    {&#39;text&#39;: &#39;Rättigheter att köra buss med över åtta sittplatser&#39;,
     &#39;is_correct&#39;: False},
    {&#39;text&#39;: &#39;Endast rättigheter att köra terränghjuling&#39;,
     &#39;is_correct&#39;: False}]},
  {&#39;uuid&#39;: &#39;2&#39;,
   &#39;text&#39;: &#39;Vilken typ av fordon får man inte köra med ett B-körkort?&#39;,
   &#39;answers&#39;: [{&#39;text&#39;: &#39;Personbil med högst 8 sittplatser&#39;,
     &#39;is_correct&#39;: False},
    {&#39;text&#39;: &#39;Buss med över åtta sittplatser&#39;, &#39;is_correct&#39;: True},
    {&#39;text&#39;: &#39;Lätt släpfordon med totalvikt över 750kg&#39;, &#39;is_correct&#39;: False},
    {&#39;text&#39;: &#39;Motorredskap klass 1&#39;, &#39;is_correct&#39;: False}]},
  {&#39;uuid&#39;: &#39;3&#39;,
   &#39;text&#39;: &#39;Vad krävs för att få köra terränghjuling?&#39;,
   &#39;answers&#39;: [{&#39;text&#39;: &#39;Ett förarbevis för terränghjuling&#39;,
     &#39;is_correct&#39;: True},
    {&#39;text&#39;: &#39;Ett B-körkort&#39;, &#39;is_correct&#39;: False},
    {&#39;text&#39;: &#39;Ett förarbevis för motorredskap klass 1&#39;, &#39;is_correct&#39;: False},
    {&#39;text&#39;: &#39;Ett förarbevis för terrängvagn&#39;, &#39;is_correct&#39;: False}]},
  {&#39;uuid&#39;: &#39;4&#39;,
   &#39;text&#39;: &#39;Vilken typ av fordon får man köra med ett B-körkort?&#39;,
   &#39;answers&#39;: [{&#39;text&#39;: &#39;Moped klass 2&#39;, &#39;is_correct&#39;: True},
    {&#39;text&#39;: &#39;Terrängvagn&#39;, &#39;is_correct&#39;: False},
    {&#39;text&#39;: &#39;Fyrhjulig motorcykel&#39;, &#39;is_correct&#39;: False},
    {&#39;text&#39;: &#39;Lastbilssläp&#39;, &#39;is_correct&#39;: False}]},
  {&#39;uuid&#39;: &#39;5&#39;,
   &#39;text&#39;: &#39;Vad ingår i behörigheten för ett B-körkort?&#39;,
   &#39;answers&#39;: [{&#39;text&#39;: &#39;Moped klass 1&#39;, &#39;is_correct&#39;: True},
    {&#39;text&#39;: &#39;Motorredskap klass 2&#39;, &#39;is_correct&#39;: True},
    {&#39;text&#39;: &#39;A och B traktorer&#39;, &#39;is_correct&#39;: True},
    {&#39;text&#39;: &#39;Terränghjuling&#39;, &#39;is_correct&#39;: False}]}]}
</code></pre></div>

<p>While it did mess up the UUID, this is still quite good. Here's an English translation:</p>
<div class="codehilite"><pre><span></span><code><span class="p">{</span><span class="s1">&#39;questions&#39;</span><span class="p">:</span><span class="w"> </span><span class="p">[{</span><span class="s1">&#39;uuid&#39;</span><span class="p">:</span><span class="w"> </span><span class="s1">&#39;1&#39;</span><span class="p">,</span><span class="w"></span>
<span class="w">   </span><span class="s1">&#39;text&#39;</span><span class="p">:</span><span class="w"> </span><span class="s1">&#39;What does a B driver&#39;</span><span class="n">s</span><span class="w"> </span><span class="n">license</span><span class="w"> </span><span class="n">entail</span><span class="err">?</span><span class="s1">&#39;,</span>
<span class="w">   </span><span class="s1">&#39;answers&#39;</span><span class="p">:</span><span class="w"> </span><span class="p">[{</span><span class="s1">&#39;text&#39;</span><span class="p">:</span><span class="w"> </span><span class="s1">&#39;Rights to drive a variety of things&#39;</span><span class="p">,</span><span class="w"></span>
<span class="w">     </span><span class="s1">&#39;is_correct&#39;</span><span class="p">:</span><span class="w"> </span><span class="n">True</span><span class="p">},</span><span class="w"></span>
<span class="w">    </span><span class="p">{</span><span class="s1">&#39;text&#39;</span><span class="p">:</span><span class="w"> </span><span class="s1">&#39;Only rights to drive a regular car&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;is_correct&#39;</span><span class="p">:</span><span class="w"> </span><span class="n">False</span><span class="p">},</span><span class="w"></span>
<span class="w">    </span><span class="p">{</span><span class="s1">&#39;text&#39;</span><span class="p">:</span><span class="w"> </span><span class="s1">&#39;Rights to drive a bus with over eight seats&#39;</span><span class="p">,</span><span class="w"></span>
<span class="w">     </span><span class="s1">&#39;is_correct&#39;</span><span class="p">:</span><span class="w"> </span><span class="n">False</span><span class="p">},</span><span class="w"></span>
<span class="w">    </span><span class="p">{</span><span class="s1">&#39;text&#39;</span><span class="p">:</span><span class="w"> </span><span class="s1">&#39;Only rights to drive an all-terrain vehicle&#39;</span><span class="p">,</span><span class="w"></span>
<span class="w">     </span><span class="s1">&#39;is_correct&#39;</span><span class="p">:</span><span class="w"> </span><span class="n">False</span><span class="p">}]},</span><span class="w"></span>
<span class="w">  </span><span class="p">{</span><span class="s1">&#39;uuid&#39;</span><span class="p">:</span><span class="w"> </span><span class="s1">&#39;2&#39;</span><span class="p">,</span><span class="w"></span>
<span class="w">   </span><span class="s1">&#39;text&#39;</span><span class="p">:</span><span class="w"> </span><span class="s1">&#39;What type of vehicle are you not allowed to drive with a B driver&#39;</span><span class="n">s</span><span class="w"> </span><span class="n">license</span><span class="err">?</span><span class="s1">&#39;,</span>
<span class="w">   </span><span class="s1">&#39;answers&#39;</span><span class="p">:</span><span class="w"> </span><span class="p">[{</span><span class="s1">&#39;text&#39;</span><span class="p">:</span><span class="w"> </span><span class="s1">&#39;Passenger car with a maximum of 8 seats&#39;</span><span class="p">,</span><span class="w"></span>
<span class="w">     </span><span class="s1">&#39;is_correct&#39;</span><span class="p">:</span><span class="w"> </span><span class="n">False</span><span class="p">},</span><span class="w"></span>
<span class="w">    </span><span class="p">{</span><span class="s1">&#39;text&#39;</span><span class="p">:</span><span class="w"> </span><span class="s1">&#39;Bus with over eight seats&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;is_correct&#39;</span><span class="p">:</span><span class="w"> </span><span class="n">True</span><span class="p">},</span><span class="w"></span>
<span class="w">    </span><span class="p">{</span><span class="s1">&#39;text&#39;</span><span class="p">:</span><span class="w"> </span><span class="s1">&#39;Light trailer with a total weight over 750kg&#39;</span><span class="p">,</span><span class="w"></span>
<span class="w">     </span><span class="s1">&#39;is_correct&#39;</span><span class="p">:</span><span class="w"> </span><span class="n">False</span><span class="p">},</span><span class="w"></span>
<span class="w">    </span><span class="p">{</span><span class="s1">&#39;text&#39;</span><span class="p">:</span><span class="w"> </span><span class="s1">&#39;Motor implement class 1&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;is_correct&#39;</span><span class="p">:</span><span class="w"> </span><span class="n">False</span><span class="p">}]},</span><span class="w"></span>
<span class="w">  </span><span class="p">{</span><span class="s1">&#39;uuid&#39;</span><span class="p">:</span><span class="w"> </span><span class="s1">&#39;3&#39;</span><span class="p">,</span><span class="w"></span>
<span class="w">   </span><span class="s1">&#39;text&#39;</span><span class="p">:</span><span class="w"> </span><span class="s1">&#39;What is required to drive an all-terrain vehicle?&#39;</span><span class="p">,</span><span class="w"></span>
<span class="w">   </span><span class="s1">&#39;answers&#39;</span><span class="p">:</span><span class="w"> </span><span class="p">[{</span><span class="s1">&#39;text&#39;</span><span class="p">:</span><span class="w"> </span><span class="s1">&#39;A driver&#39;</span><span class="n">s</span><span class="w"> </span><span class="n">permit</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="n">all</span><span class="o">-</span><span class="n">terrain</span><span class="w"> </span><span class="n">vehicles</span><span class="s1">&#39;,</span>
<span class="w">     </span><span class="s1">&#39;is_correct&#39;</span><span class="p">:</span><span class="w"> </span><span class="n">True</span><span class="p">},</span><span class="w"></span>
<span class="w">    </span><span class="p">{</span><span class="s1">&#39;text&#39;</span><span class="p">:</span><span class="w"> </span><span class="s1">&#39;A B driver&#39;</span><span class="n">s</span><span class="w"> </span><span class="n">license</span><span class="s1">&#39;, &#39;</span><span class="n">is_correct</span><span class="s1">&#39;: False},</span>
<span class="w">    </span><span class="p">{</span><span class="s1">&#39;text&#39;</span><span class="p">:</span><span class="w"> </span><span class="s1">&#39;A driver&#39;</span><span class="n">s</span><span class="w"> </span><span class="n">permit</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="n">motor</span><span class="w"> </span><span class="n">implements</span><span class="w"> </span><span class="k">class</span><span class="w"> </span><span class="mi">1</span><span class="s1">&#39;,</span>
<span class="w">     </span><span class="s1">&#39;is_correct&#39;</span><span class="p">:</span><span class="w"> </span><span class="n">False</span><span class="p">},</span><span class="w"></span>
<span class="w">    </span><span class="p">{</span><span class="s1">&#39;text&#39;</span><span class="p">:</span><span class="w"> </span><span class="s1">&#39;A driver&#39;</span><span class="n">s</span><span class="w"> </span><span class="n">permit</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="n">off</span><span class="o">-</span><span class="n">road</span><span class="w"> </span><span class="n">vehicles</span><span class="s1">&#39;, &#39;</span><span class="n">is_correct</span><span class="s1">&#39;: False}]},</span>
<span class="w">  </span><span class="p">{</span><span class="s1">&#39;uuid&#39;</span><span class="p">:</span><span class="w"> </span><span class="s1">&#39;4&#39;</span><span class="p">,</span><span class="w"></span>
<span class="w">   </span><span class="s1">&#39;text&#39;</span><span class="p">:</span><span class="w"> </span><span class="s1">&#39;What type of vehicle can you drive with a B driver&#39;</span><span class="n">s</span><span class="w"> </span><span class="n">license</span><span class="err">?</span><span class="s1">&#39;,</span>
<span class="w">   </span><span class="s1">&#39;answers&#39;</span><span class="p">:</span><span class="w"> </span><span class="p">[{</span><span class="s1">&#39;text&#39;</span><span class="p">:</span><span class="w"> </span><span class="s1">&#39;Moped class 2&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;is_correct&#39;</span><span class="p">:</span><span class="w"> </span><span class="n">True</span><span class="p">},</span><span class="w"></span>
<span class="w">    </span><span class="p">{</span><span class="s1">&#39;text&#39;</span><span class="p">:</span><span class="w"> </span><span class="s1">&#39;Off-road vehicle&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;is_correct&#39;</span><span class="p">:</span><span class="w"> </span><span class="n">False</span><span class="p">},</span><span class="w"></span>
<span class="w">    </span><span class="p">{</span><span class="s1">&#39;text&#39;</span><span class="p">:</span><span class="w"> </span><span class="s1">&#39;Quad bike&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;is_correct&#39;</span><span class="p">:</span><span class="w"> </span><span class="n">False</span><span class="p">},</span><span class="w"></span>
<span class="w">    </span><span class="p">{</span><span class="s1">&#39;text&#39;</span><span class="p">:</span><span class="w"> </span><span class="s1">&#39;Truck trailer&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;is_correct&#39;</span><span class="p">:</span><span class="w"> </span><span class="n">False</span><span class="p">}]},</span><span class="w"></span>
<span class="w">  </span><span class="p">{</span><span class="s1">&#39;uuid&#39;</span><span class="p">:</span><span class="w"> </span><span class="s1">&#39;5&#39;</span><span class="p">,</span><span class="w"></span>
<span class="w">   </span><span class="s1">&#39;text&#39;</span><span class="p">:</span><span class="w"> </span><span class="s1">&#39;What is included in the entitlement of a B driver&#39;</span><span class="n">s</span><span class="w"> </span><span class="n">license</span><span class="err">?</span><span class="s1">&#39;,</span>
<span class="w">   </span><span class="s1">&#39;answers&#39;</span><span class="p">:</span><span class="w"> </span><span class="p">[{</span><span class="s1">&#39;text&#39;</span><span class="p">:</span><span class="w"> </span><span class="s1">&#39;Moped class 1&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;is_correct&#39;</span><span class="p">:</span><span class="w"> </span><span class="n">True</span><span class="p">},</span><span class="w"></span>
<span class="w">    </span><span class="p">{</span><span class="s1">&#39;text&#39;</span><span class="p">:</span><span class="w"> </span><span class="s1">&#39;Motor implement class 2&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;is_correct&#39;</span><span class="p">:</span><span class="w"> </span><span class="n">True</span><span class="p">},</span><span class="w"></span>
<span class="w">    </span><span class="p">{</span><span class="s1">&#39;text&#39;</span><span class="p">:</span><span class="w"> </span><span class="s1">&#39;A and B tractors&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;is_correct&#39;</span><span class="p">:</span><span class="w"> </span><span class="n">True</span><span class="p">},</span><span class="w"></span>
<span class="w">    </span><span class="p">{</span><span class="s1">&#39;text&#39;</span><span class="p">:</span><span class="w"> </span><span class="s1">&#39;All-terrain vehicle&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;is_correct&#39;</span><span class="p">:</span><span class="w"> </span><span class="n">False</span><span class="p">}]}]}</span><span class="w"></span>
</code></pre></div>

<p>One of the challenges we had during development is giving feedback to the student when they answered incorrectly. The teachers at the school didn't really have the time to go back and add customized feedback for the wrong answers. Let's see what the model can do. Assuming the following JSON input (limited to 2 questions):</p>
<div class="codehilite"><pre><span></span><code><span class="n">quiz_attempt</span> <span class="o">=</span> <span class="p">{</span>
  <span class="s2">&quot;questions&quot;</span><span class="p">:</span> <span class="p">[</span>
    <span class="p">{</span>
      <span class="s2">&quot;uuid&quot;</span><span class="p">:</span> <span class="s2">&quot;1&quot;</span><span class="p">,</span>
      <span class="s2">&quot;text&quot;</span><span class="p">:</span> <span class="s2">&quot;What does a B driver&#39;s license entail?&quot;</span><span class="p">,</span>
      <span class="s2">&quot;answers&quot;</span><span class="p">:</span> <span class="p">[</span>
        <span class="p">{</span>
          <span class="s2">&quot;text&quot;</span><span class="p">:</span> <span class="s2">&quot;Rights to drive a variety of things&quot;</span><span class="p">,</span>
          <span class="s2">&quot;is_correct&quot;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span>
          <span class="s2">&quot;is_selected&quot;</span><span class="p">:</span> <span class="kc">False</span> 
        <span class="p">},</span>
        <span class="p">{</span>
          <span class="s2">&quot;text&quot;</span><span class="p">:</span> <span class="s2">&quot;Only rights to drive a regular car&quot;</span><span class="p">,</span>
          <span class="s2">&quot;is_correct&quot;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span>
          <span class="s2">&quot;is_selected&quot;</span><span class="p">:</span> <span class="kc">False</span>
        <span class="p">},</span>
        <span class="p">{</span>
          <span class="s2">&quot;text&quot;</span><span class="p">:</span> <span class="s2">&quot;Rights to drive a bus with over eight seats&quot;</span><span class="p">,</span>
          <span class="s2">&quot;is_correct&quot;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span>
          <span class="s2">&quot;is_selected&quot;</span><span class="p">:</span> <span class="kc">False</span>
        <span class="p">},</span>
        <span class="p">{</span>
          <span class="s2">&quot;text&quot;</span><span class="p">:</span> <span class="s2">&quot;Only rights to drive an all-terrain vehicle&quot;</span><span class="p">,</span>
          <span class="s2">&quot;is_correct&quot;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span>
          <span class="s2">&quot;is_selected&quot;</span><span class="p">:</span> <span class="kc">False</span>
        <span class="p">}</span>
      <span class="p">]</span>
    <span class="p">},</span>
    <span class="p">{</span>
      <span class="s2">&quot;uuid&quot;</span><span class="p">:</span> <span class="s2">&quot;2&quot;</span><span class="p">,</span>
      <span class="s2">&quot;text&quot;</span><span class="p">:</span> <span class="s2">&quot;What type of vehicle are you not allowed to drive with a B driver&#39;s license?&quot;</span><span class="p">,</span>
      <span class="s2">&quot;answers&quot;</span><span class="p">:</span> <span class="p">[</span>
        <span class="p">{</span>
          <span class="s2">&quot;text&quot;</span><span class="p">:</span> <span class="s2">&quot;Passenger car with a maximum of 8 seats&quot;</span><span class="p">,</span>
          <span class="s2">&quot;is_correct&quot;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span>
          <span class="s2">&quot;is_selected&quot;</span><span class="p">:</span> <span class="kc">False</span>
        <span class="p">},</span>
        <span class="p">{</span>
          <span class="s2">&quot;text&quot;</span><span class="p">:</span> <span class="s2">&quot;Bus with over eight seats&quot;</span><span class="p">,</span>
          <span class="s2">&quot;is_correct&quot;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span>
          <span class="s2">&quot;is_selected&quot;</span><span class="p">:</span> <span class="kc">False</span>
        <span class="p">},</span>
        <span class="p">{</span>
          <span class="s2">&quot;text&quot;</span><span class="p">:</span> <span class="s2">&quot;Light trailer with a total weight over 750kg&quot;</span><span class="p">,</span>
          <span class="s2">&quot;is_correct&quot;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span>
          <span class="s2">&quot;is_selected&quot;</span><span class="p">:</span> <span class="kc">False</span>
        <span class="p">},</span>
        <span class="p">{</span>
          <span class="s2">&quot;text&quot;</span><span class="p">:</span> <span class="s2">&quot;Motor implement class 1&quot;</span><span class="p">,</span>
          <span class="s2">&quot;is_correct&quot;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span>
          <span class="s2">&quot;is_selected&quot;</span><span class="p">:</span> <span class="kc">False</span>
        <span class="p">}</span>
      <span class="p">]</span>
    <span class="p">}</span>
  <span class="p">]</span>
<span class="p">}</span>
</code></pre></div>

<div class="codehilite"><pre><span></span><code><span class="n">template</span> <span class="o">=</span> <span class="p">(</span>
    <span class="s2">&quot;A user has just submitted a quiz - </span><span class="si">{context}</span><span class="s2">. Go through each question, validate whether the answer is correct based &quot;</span>
    <span class="s2">&quot;based on whether correct answers were selected, and state whether the user is correct or incorrect, and add an explanation &quot;</span>
    <span class="s2">&quot;with feedback so that the user knows why they&#39;re right or wrong. Add your feedback &#39;feedback&#39; to each questions. &quot;</span>
    <span class="s2">&quot;Your output should be JSON as well.&quot;</span>
<span class="p">)</span>

<span class="n">chain</span> <span class="o">=</span> <span class="n">LLMChain</span><span class="p">(</span>
    <span class="n">llm</span><span class="o">=</span><span class="n">ChatOpenAI</span><span class="p">(),</span>
    <span class="n">prompt</span><span class="o">=</span><span class="n">ChatPromptTemplate</span><span class="o">.</span><span class="n">from_messages</span><span class="p">([</span><span class="n">SystemMessagePromptTemplate</span><span class="o">.</span><span class="n">from_template</span><span class="p">(</span><span class="n">template</span><span class="p">)]),</span>
    <span class="n">output_parser</span><span class="o">=</span><span class="n">StrOutputParser</span><span class="p">()</span>
<span class="p">)</span>

<span class="n">chain</span><span class="o">.</span><span class="n">run</span><span class="p">({</span> <span class="s2">&quot;context&quot;</span><span class="p">:</span> <span class="n">quiz_attempt</span> <span class="p">})</span>
</code></pre></div>

<div class="codehilite"><pre><span></span><code><span class="s1">&#39;{&quot;questions&quot;: [</span><span class="se">\n</span><span class="s1">    {</span><span class="se">\n</span><span class="s1">        &quot;uuid&quot;: &quot;1&quot;,</span><span class="se">\n</span><span class="s1">        &quot;text&quot;: &quot;What does a B driver</span><span class="se">\&#39;</span><span class="s1">s license entail?&quot;,</span><span class="se">\n</span><span class="s1">        &quot;answers&quot;: [</span><span class="se">\n</span><span class="s1">            {&quot;text&quot;: &quot;Rights to drive a variety of things&quot;, &quot;is_correct&quot;: true, &quot;is_selected&quot;: false},</span><span class="se">\n</span><span class="s1">            {&quot;text&quot;: &quot;Only rights to drive a regular car&quot;, &quot;is_correct&quot;: false, &quot;is_selected&quot;: false},</span><span class="se">\n</span><span class="s1">            {&quot;text&quot;: &quot;Rights to drive a bus with over eight seats&quot;, &quot;is_correct&quot;: false, &quot;is_selected&quot;: false},</span><span class="se">\n</span><span class="s1">            {&quot;text&quot;: &quot;Only rights to drive an all-terrain vehicle&quot;, &quot;is_correct&quot;: false, &quot;is_selected&quot;: false}</span><span class="se">\n</span><span class="s1">        ],</span><span class="se">\n</span><span class="s1">        &quot;feedback&quot;: &quot;The correct answer is </span><span class="se">\&#39;</span><span class="s1">Rights to drive a variety of things</span><span class="se">\&#39;</span><span class="s1">. A B driver</span><span class="se">\&#39;</span><span class="s1">s license allows you to drive a regular car as well as other vehicles such as motorcycles and light trucks.&quot;</span><span class="se">\n</span><span class="s1">    },</span><span class="se">\n</span><span class="s1">    {</span><span class="se">\n</span><span class="s1">        &quot;uuid&quot;: &quot;2&quot;,</span><span class="se">\n</span><span class="s1">        &quot;text&quot;: &quot;What type of vehicle are you not allowed to drive with a B driver</span><span class="se">\&#39;</span><span class="s1">s license?&quot;,</span><span class="se">\n</span><span class="s1">        &quot;answers&quot;: [</span><span class="se">\n</span><span class="s1">            {&quot;text&quot;: &quot;Passenger car with a maximum of 8 seats&quot;, &quot;is_correct&quot;: false, &quot;is_selected&quot;: false},</span><span class="se">\n</span><span class="s1">            {&quot;text&quot;: &quot;Bus with over eight seats&quot;, &quot;is_correct&quot;: true, &quot;is_selected&quot;: false},</span><span class="se">\n</span><span class="s1">            {&quot;text&quot;: &quot;Light trailer with a total weight over 750kg&quot;, &quot;is_correct&quot;: false, &quot;is_selected&quot;: false},</span><span class="se">\n</span><span class="s1">            {&quot;text&quot;: &quot;Motor implement class 1&quot;, &quot;is_correct&quot;: false, &quot;is_selected&quot;: false}</span><span class="se">\n</span><span class="s1">        ],</span><span class="se">\n</span><span class="s1">        &quot;feedback&quot;: &quot;The correct answer is </span><span class="se">\&#39;</span><span class="s1">Bus with over eight seats</span><span class="se">\&#39;</span><span class="s1">. With a B driver</span><span class="se">\&#39;</span><span class="s1">s license, you are not allowed to drive a bus with over eight seats.&quot;</span><span class="se">\n</span><span class="s1">    }</span><span class="se">\n</span><span class="s1">]}&#39;</span><span class="w"></span>
</code></pre></div>

<p>Converting the answer to a more readable JSON format, we get, with the fluff removed:</p>
<div class="codehilite"><pre><span></span><code><span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="s2">&quot;questions&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="w"></span>
<span class="w">    </span><span class="p">{</span><span class="w"></span>
<span class="w">      </span><span class="s2">&quot;text&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;What does a B driver&#39;s license entail?&quot;</span><span class="p">,</span><span class="w"></span>
<span class="w">      </span><span class="s2">&quot;feedback&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;The correct answer is &#39;Rights to drive a variety of things&#39;. A B driver&#39;s license allows you to drive a regular car as well as other vehicles such as motorcycles and light trucks.&quot;</span><span class="w"></span>
<span class="w">    </span><span class="p">},</span><span class="w"></span>
<span class="w">    </span><span class="p">{</span><span class="w"></span>
<span class="w">      </span><span class="s2">&quot;text&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;What type of vehicle are you not allowed to drive with a B driver&#39;s license?&quot;</span><span class="p">,</span><span class="w"></span>
<span class="w">      </span><span class="s2">&quot;feedback&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;The correct answer is &#39;Bus with over eight seats&#39;. With a B driver&#39;s license, you are not allowed to drive a bus with over eight seats.&quot;</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>
<span class="w">  </span><span class="p">]</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</code></pre></div>

<p>Honestly, not too bad. I'd like to see how it does with more complicated "data" but not a bad start for a PoC.</p>
<p>In summary; we're able to (as a PoC):</p>
<ul>
<li>Generate new questions based on pre-defined content</li>
<li>Evaluate and give feedback to the student based on their quiz attempts</li>
</ul>
<h3>Simulator</h3>
<p>Now for the most exciting part - guiding a student towards a specific mission that'll help them address their driving weaknesses.</p>
<p>Let's paint the scenario a little bit.</p>
<ul>
<li>You have access to the first 60 missions we have in the simulator right now: <code>https://***/v1/missions/?type=automatic</code></li>
<li>You're going to practice for your automatic B-driving license</li>
<li>You're struggling with roundabouts - well we have a mission for that.</li>
<li>Let's see if the "AI-mentor" can guide the student to "practice" that mission.</li>
</ul>
<p>From a technical perspective - we should:
* Fetch all the information about the missions
* Store them in our vector database as embeddings
* Query the vector database and return all "relevant" matches
* Pass the matches to model and give the user what they want</p>
<div class="codehilite"><pre><span></span><code><span class="c1"># For the demo, I&#39;ve saved the mission information in a local .json file</span>

<span class="n">missions</span> <span class="o">=</span> <span class="s2">&quot;./missions.json&quot;</span>

<span class="kn">from</span> <span class="nn">langchain.document_loaders</span> <span class="kn">import</span> <span class="n">JSONLoader</span>
<span class="kn">from</span> <span class="nn">pprint</span> <span class="kn">import</span> <span class="n">pprint</span>

<span class="n">loader</span> <span class="o">=</span> <span class="n">JSONLoader</span><span class="p">(</span><span class="n">file_path</span><span class="o">=</span><span class="n">missions</span><span class="p">,</span> <span class="n">jq_schema</span><span class="o">=</span><span class="s1">&#39;.automatic_missions.sections[].subsections[].missions[] | &quot;\(.title): \(.description)&quot;&#39;</span><span class="p">)</span>
<span class="n">data</span> <span class="o">=</span> <span class="n">loader</span><span class="o">.</span><span class="n">load</span><span class="p">()</span>

<span class="n">db</span> <span class="o">=</span> <span class="n">Chroma</span><span class="o">.</span><span class="n">from_documents</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">OpenAIEmbeddings</span><span class="p">())</span>
</code></pre></div>

<div class="codehilite"><pre><span></span><code><span class="n">user_query</span> <span class="o">=</span> <span class="s2">&quot;I can&#39;t drive around roundabouts. What can I do?&quot;</span>
</code></pre></div>

<div class="codehilite"><pre><span></span><code><span class="n">mission_context</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">similarity_search</span><span class="p">(</span><span class="n">user_query</span><span class="p">)</span>
</code></pre></div>

<div class="codehilite"><pre><span></span><code><span class="n">template</span> <span class="o">=</span> <span class="p">(</span>
    <span class="s2">&quot;As a traffic school mentor, suggest what the user can do to deal with what they&#39;re struggling with - </span><span class="si">{query}</span><span class="s2">&quot;</span>
    <span class="s2">&quot;Based on the context - </span><span class="si">{context}</span><span class="s2">, if the user needs to practice a mission, suggest which missions a user should practice. &quot;</span>
    <span class="s2">&quot;Use the sequence numbers in the meta data as the mission numbers in your output. &quot;</span>
    <span class="s2">&quot;Also mention why you&#39;re suggesting that mission.&quot;</span>
<span class="p">)</span>

<span class="n">chain</span> <span class="o">=</span> <span class="n">LLMChain</span><span class="p">(</span>
    <span class="n">llm</span><span class="o">=</span><span class="n">ChatOpenAI</span><span class="p">(),</span>
    <span class="n">prompt</span><span class="o">=</span><span class="n">ChatPromptTemplate</span><span class="o">.</span><span class="n">from_messages</span><span class="p">([</span><span class="n">SystemMessagePromptTemplate</span><span class="o">.</span><span class="n">from_template</span><span class="p">(</span><span class="n">template</span><span class="p">)]),</span>
    <span class="n">output_parser</span><span class="o">=</span><span class="n">StrOutputParser</span><span class="p">()</span>
<span class="p">)</span>

<span class="n">pprint</span><span class="p">(</span><span class="n">chain</span><span class="o">.</span><span class="n">run</span><span class="p">({</span> <span class="s2">&quot;context&quot;</span><span class="p">:</span> <span class="n">mission_context</span><span class="p">,</span> <span class="s2">&quot;query&quot;</span><span class="p">:</span> <span class="n">user_query</span> <span class="p">}))</span>
</code></pre></div>

<div class="codehilite"><pre><span></span><code><span class="p">(</span><span class="s2">&quot;If you&#39;re struggling with driving around roundabouts, I suggest practicing &quot;</span><span class="w"></span>
<span class="w"> </span><span class="s1">&#39;Mission 42 and Mission 43. </span><span class="se">\n</span><span class="s1">&#39;</span><span class="w"></span>
<span class="w"> </span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="w"></span>
<span class="w"> </span><span class="s1">&#39;Mission 42 involves driving through three roundabouts with traffic and &#39;</span><span class="w"></span>
<span class="w"> </span><span class="s1">&#39;making a right turn at the exit. This mission will help you gain experience &#39;</span><span class="w"></span>
<span class="w"> </span><span class="s1">&#39;in navigating roundabouts with other vehicles present, which can be a common &#39;</span><span class="w"></span>
<span class="w"> </span><span class="s1">&#39;challenge for many drivers.</span><span class="se">\n</span><span class="s1">&#39;</span><span class="w"></span>
<span class="w"> </span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="w"></span>
<span class="w"> </span><span class="s1">&#39;Mission 43, on the other hand, involves driving through three roundabouts &#39;</span><span class="w"></span>
<span class="w"> </span><span class="s1">&#39;without any traffic and making a simple right turn. This mission will allow &#39;</span><span class="w"></span>
<span class="w"> </span><span class="s1">&#39;you to practice navigating roundabouts in a less stressful environment, &#39;</span><span class="w"></span>
<span class="w"> </span><span class="s1">&#39;allowing you to focus on the fundamental techniques and build your &#39;</span><span class="w"></span>
<span class="w"> </span><span class="s1">&#39;confidence.</span><span class="se">\n</span><span class="s1">&#39;</span><span class="w"></span>
<span class="w"> </span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="w"></span>
<span class="w"> </span><span class="s1">&#39;By practicing these missions, you will be able to familiarize yourself with &#39;</span><span class="w"></span>
<span class="w"> </span><span class="s1">&#39;the roundabout driving techniques and gain the necessary skills to drive &#39;</span><span class="w"></span>
<span class="w"> </span><span class="s1">&#39;around roundabouts with ease. Remember to always follow the traffic rules &#39;</span><span class="w"></span>
<span class="w"> </span><span class="s1">&#39;and signals while driving.&#39;</span><span class="p">)</span><span class="w"></span>
</code></pre></div>

<p>Not too bad given that the model only had desriptions of the missions to go off of. With a bit more metadata, we can turn it into a richer experience.</p>
<h3>Next steps</h3>
<p>The next thing to work on is connecting all of this via "chains" (it's LangChain
afterall), where the model feeds outputs from one stage into another and also
takes decisions to truly "mentor" the student based on what they're asking.</p>
<ul>
<li>Chains: <a href="https://python.langchain.com/docs/modules/chains/">https://python.langchain.com/docs/modules/chains/</a></li>
<li>Agents: <a href="https://python.langchain.com/docs/modules/agents.html">https://python.langchain.com/docs/modules/agents.html</a></li>
</ul>
      </div>
<!-- /.entry-content -->

    <div>
    </div>

    <footer class="text-orange">
      <span class="text-orange">Category:</span> <a href="https://strativ-dev.github.io/engineering-at-strativ/category/generative-ai.html">Generative AI</a>

      <div>
        Tags:
        <button type="button" class="btn btn-default">
          <a href="https://strativ-dev.github.io/engineering-at-strativ/tag/llm.html">llm</a>
        </button>
        <button type="button" class="btn btn-default">
          <a href="https://strativ-dev.github.io/engineering-at-strativ/tag/generative-ai.html">generative-ai</a>
        </button>
        <button type="button" class="btn btn-default">
          <a href="https://strativ-dev.github.io/engineering-at-strativ/tag/traffic-school.html">traffic-school</a>
        </button>
        <button type="button" class="btn btn-default">
          <a href="https://strativ-dev.github.io/engineering-at-strativ/tag/e-learning.html">e-learning</a>
        </button>
    </div>
    </footer>
    <!-- /.post-info -->
    </section>
</div>
    <script
      src="https://cdn.jsdelivr.net/npm/bootstrap@5.2.2/dist/js/bootstrap.bundle.min.js"
      integrity="sha384-OERcA2EqjJCMA+/3y+gxIOqMEjwtxJY7qPCqsdltbNJuaOe923+mo//f6V8Qbsw3"
      crossorigin="anonymous"
    ></script>
  </body>
</html>